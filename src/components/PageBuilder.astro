---
import type { PortableTextProps } from "astro-portabletext/types";
import RichText from "./RichText.astro";
import SanityImage from "./SanityImage.astro";

interface FeaturedProduct {
  _id: string;
  title: string | null;
  slug: string | null;
  price: number | null;
  image: string | null;
  featuredImage: string | null;
}

interface EditorialBlock {
  _key: string;
  _type: "editorialSection";
  cover?: Array<{
    _type: string;
    backgroundImage?: { asset: any; alt?: string } | null;
    color?: string | null;
  }>;
  content?: any;
  textColor?: string;
}

interface FeaturedProductsBlock {
  _key: string;
  _type: "featuredProducts";
  products?: FeaturedProduct[];
}

type PageBlock = EditorialBlock | FeaturedProductsBlock;

interface Props {
  pageBuilder: PageBlock[] | null;
}

const { pageBuilder } = Astro.props;
---

<style>
  .section {
    position: relative;
    aspect-ratio: 16/9;
    width: 100vw;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 768px) {
    .section {
      aspect-ratio: 1/1;
    }
  }

  .background {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
  }

  .background img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .content {
    position: relative;
    z-index: 1;
    max-width: 800px;
    padding: 2rem;
    text-align: center;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    padding: 4rem 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  @media (max-width: 768px) {
    .products-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      padding: 2rem 1rem;
    }
  }

  .product-card {
    display: block;
    text-decoration: none;
    color: inherit;
  }

  .product-card img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
  }

  .product-card h3 {
    margin-top: 0.75rem;
    font-size: 1rem;
    font-weight: 400;
  }

  .product-card .price {
    font-size: 0.875rem;
    opacity: 0.7;
  }
</style>

{
  pageBuilder?.map((block, index) => {
    if (block._type === "featuredProducts" && block.products) {
      return (
        <section class="products-grid">
          {block.products.map((product) => (
            <a href={`/products/${product.slug}`} class="product-card">
              {(product.featuredImage || product.image) && (
                <img
                  src={product.featuredImage || product.image}
                  alt={product.title || "Product"}
                  loading="lazy"
                />
              )}
              <h3>{product.title}</h3>
              {product.price && <p class="price">${product.price}</p>}
            </a>
          ))}
        </section>
      );
    }

    return (
      <section
        class="section"
        style={{ backgroundColor: `${block.cover?.[0]?.color ?? "#000"}` }}
      >
        {block.cover?.[0]?.backgroundImage?.asset && (
          <div class="background">
            <SanityImage
              node={block.cover[0].backgroundImage.asset}
              alt={block.cover[0].backgroundImage.alt}
              loading={index === 0 ? "eager" : "lazy"}
              aspectRatio="16-9"
              mobileAspectRatio="1-1"
            />
          </div>
        )}
        <div class="content" style={{ color: `${block.textColor ?? "#000"}` }}>
          <RichText content={block?.content as PortableTextProps["value"]} />
        </div>
      </section>
    );
  })
}
