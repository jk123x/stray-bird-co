---
import type { PortableTextProps } from "astro-portabletext/types";
import RichText from "./RichText.astro";
import SanityImage from "./SanityImage.astro";

interface FeaturedProduct {
  _id: string;
  title: string | null;
  slug: string | null;
  price: number | null;
  image: string | null;
  featuredImage: string | null;
}

interface EditorialBlock {
  _key: string;
  _type: "editorialSection";
  cover?: Array<{
    _type: string;
    backgroundImage?: { asset: any; alt?: string } | null;
    color?: string | null;
  }>;
  content?: any;
  textColor?: string;
}

interface FeaturedProductsBlock {
  _key: string;
  _type: "featuredProducts";
  products?: FeaturedProduct[];
}

type PageBlock = EditorialBlock | FeaturedProductsBlock;

interface Props {
  pageBuilder: PageBlock[] | null;
}

const { pageBuilder } = Astro.props;
---

<style>
  .section {
    position: relative;
    aspect-ratio: 16/9;
    width: 100vw;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (max-width: 768px) {
    .section {
      aspect-ratio: 1/1;
    }
  }

  .background {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%;
  }

  .background img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .content {
    position: relative;
    z-index: 1;
    max-width: 800px;
    padding: 2rem;
    text-align: center;
  }

</style>

{
  pageBuilder?.map((block, index) => {
    if (block._type === "featuredProducts" && block.products) {
      return (
        <section class="grid grid-cols-2 md:grid-cols-3 gap-6 md:gap-10 px-6 py-12 max-w-5xl mx-auto">
          {block.products.map((product) => (
            <a href={`/products/${product.slug}`} class="group block">
              <div class="relative aspect-square overflow-hidden">
                {(product.featuredImage || product.image) && (
                  <img
                    src={product.featuredImage || product.image}
                    alt={product.title || "Product"}
                    loading="lazy"
                    class="w-full h-full object-contain p-4 transition-all duration-500 ease-out group-hover:scale-[1.02]"
                  />
                )}
              </div>
              <div class="pt-4 space-y-1">
                <h3 class="text-base font-medium text-zinc-900 dark:text-white group-hover:text-zinc-600 dark:group-hover:text-zinc-300 transition-colors duration-200">
                  {product.title}
                </h3>
                {product.price && (
                  <p class="text-sm text-zinc-500 dark:text-pink-200 group-hover:text-emerald-600 dark:group-hover:text-pink-200 transition-colors duration-300">
                    ${product.price}
                  </p>
                )}
              </div>
            </a>
          ))}
        </section>
      );
    }

    return (
      <section
        class="section"
        style={{ backgroundColor: `${block.cover?.[0]?.color ?? "#000"}` }}
      >
        {block.cover?.[0]?.backgroundImage?.asset && (
          <div class="background">
            <SanityImage
              node={block.cover[0].backgroundImage.asset}
              alt={block.cover[0].backgroundImage.alt}
              loading={index === 0 ? "eager" : "lazy"}
              aspectRatio="16-9"
              mobileAspectRatio="1-1"
            />
          </div>
        )}
        <div class="content" style={{ color: `${block.textColor ?? "#000"}` }}>
          <RichText content={block?.content as PortableTextProps["value"]} />
        </div>
      </section>
    );
  })
}
