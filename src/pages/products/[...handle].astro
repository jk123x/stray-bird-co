---
import { getProductByHandle } from "./../../data/shopify";
import { setCache } from "../../utils/cache";
import { sanityClient } from "../../sanity/client";

import BaseLayout from "../../layouts/BaseLayout.astro";
import NotFoundLayout from "../../layouts/NotFoundLayout.astro";
import AddToCartForm from "../../components/AddToCartForm.svelte";
import ProductImageGallery from "../../components/ProductImageGallery.astro";
import ProductBreadcrumb from "../../components/ProductBreadcrumb.astro";
import ProductInformations from "../../components/ProductInformations.astro";
import ProductRecommendations from "../../components/ProductRecommendations.astro";
import ProductReviews from "../../components/ProductReviews.astro";
import ProductAccordions from "../../components/ProductAccordions.astro";

const { handle } = Astro.params;
const headers = Astro.request.headers;
const ip = headers.get("x-vercel-forwarded-for") || Astro.clientAddress;
const product = await getProductByHandle({ handle: handle || "", buyerIP: ip });

if (!product) {
  Astro.response.status = 404;
}

// Fetch Sanity product data
let sanityProduct = null;
if (product) {
  try {
    sanityProduct = await sanityClient.fetch(
      `*[_type == "product" && store.slug.current == $handle][0]`,
      { handle }
    );
  } catch (error) {
    console.error("Error fetching Sanity product:", error);
  }
}

const firstVariant = product?.variants.nodes[0];
setCache.short(Astro);
---

{
  !product ? (
    <NotFoundLayout title="Product not found" message="Product not found" />
  ) : (
    <BaseLayout title={sanityProduct?.customName || product.title}>
      <div class="container pt-6">
        <ProductBreadcrumb title={sanityProduct?.customName || product.title} />
      </div>

      <section class="container">
        <div class="pt-6 pb-16 lg:grid lg:grid-cols-12 lg:gap-20">
          <div class="lg:col-span-7">
            <ProductImageGallery 
              images={product.images} 
              variants={product.variants.nodes} 
            />
            
            {sanityProduct?.designStory && (
              <div class="mt-8 prose">
                <h3>Design Story</h3>
                {/* You may need to import PortableText to render the rich text */}
                {sanityProduct.designStory}
              </div>
            )}
          </div>

          <div class="mt-8 lg:col-span-5 lg:mt-0">
            <ProductInformations
              title={sanityProduct?.customName || product.title}
              variants={product.variants.nodes}
              price={firstVariant?.price}
            />

            {sanityProduct?.customDescription && (
              <div class="mt-4 text-gray-600">
                <p>{sanityProduct.customDescription}</p>
              </div>
            )}

            {sanityProduct?.isLimitedEdition && (
              <div class="mt-4 p-3 bg-yellow-100 border border-yellow-400 rounded">
                <p class="font-bold text-yellow-800">Limited Edition</p>
              </div>
            )}

            <div>
              <AddToCartForm
                client:load
                variants={product.variants.nodes}
                variantId={firstVariant?.id}
                variantQuantityAvailable={firstVariant?.quantityAvailable}
                variantAvailableForSale={firstVariant?.availableForSale}
              />
            </div>

            {sanityProduct?.material && (
              <div class="mt-8">
                <h3 class="font-bold">Material & Care</h3>
                <p class="text-sm text-gray-600">{sanityProduct.material}</p>
              </div>
            )}

            {sanityProduct?.sizeGuide && (
              <div class="mt-8">
                <h3 class="font-bold">Size Guide</h3>
                <p class="text-sm text-gray-600">{sanityProduct.sizeGuide}</p>
              </div>
            )}

            <div class="mt-8">
              <ProductAccordions />
            </div>
          </div>
        </div>
      </section>

      <section class="container">
        <ProductReviews />
      </section>

      <section class="container">
        <ProductRecommendations productId={product.id} buyerIP={ip} />
      </section>
    </BaseLayout>
  )
}