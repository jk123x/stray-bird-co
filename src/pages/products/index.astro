---
import { getPaginatedProducts } from "../../data/shopify";
import type { PaginatedProductsResult } from "../../data/shopify";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { setCache } from "../../utils/cache";

const title = "Products";

// Get cursor from URL for pagination
const url = new URL(Astro.request.url);
const cursor = url.searchParams.get("cursor");
const headers = Astro.request.headers;
const ip = headers.get("x-vercel-forwarded-for") || Astro.clientAddress;

const PRODUCTS_PER_PAGE = 12;

let result: PaginatedProductsResult | null = null;
let error: string | null = null;

try {
  result = await getPaginatedProducts({
    limit: PRODUCTS_PER_PAGE,
    cursor,
    buyerIP: ip,
  });
} catch (e) {
  console.error("Failed to fetch products:", e);
  error = "Unable to load products. Please try again later.";
}

setCache.short(Astro);
---

<BaseLayout title={title}>
  <section class="py-12">
    {error ? (
      <div class="text-center py-12">
        <p class="text-red-600 mb-4">{error}</p>
        <a
          href="/products"
          class="inline-block px-4 py-2 bg-emerald-900 text-white rounded hover:bg-emerald-800"
        >
          Try Again
        </a>
      </div>
    ) : result && result.products.length > 0 ? (
      <>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-6 md:gap-10 px-6 py-12 max-w-5xl mx-auto">
          {result.products.sort((a, b) => a.title.localeCompare(b.title)).map((product) => (
            <a href={`/products/${product.handle}`} class="group block">
              <div class="relative aspect-square overflow-hidden">
                {product.featuredImage && (
                  <img
                    src={product.featuredImage.url}
                    alt={product.featuredImage.altText || product.title}
                    loading="lazy"
                    class="w-full h-full object-contain p-4 transition-all duration-500 ease-out group-hover:scale-[1.02]"
                  />
                )}
              </div>
              <div class="pt-4 space-y-1">
                <h3 class="text-base font-medium text-zinc-900 dark:text-white group-hover:text-zinc-600 dark:group-hover:text-zinc-300 transition-colors duration-200">
                  {product.title}
                </h3>
                <p class="text-sm text-zinc-500 dark:text-pink-200 group-hover:text-emerald-600 dark:group-hover:text-pink-200 transition-colors duration-300">
                  {new Intl.NumberFormat("en-US", {
                    style: "currency",
                    currency: product.variants.nodes[0]?.price.currencyCode ?? "USD",
                  }).format(parseFloat(product.variants.nodes[0]?.price.amount ?? "0"))}
                </p>
              </div>
            </a>
          ))}
        </div>

        {/* Pagination Controls */}
        {(cursor || (result.pageInfo.hasNextPage && result.pageInfo.endCursor)) && (
          <nav class="mt-8 flex justify-center gap-4" aria-label="Pagination">
            {cursor && (
              <a
                href="/products"
                class="px-4 py-2 border border-zinc-300 dark:border-zinc-700 rounded hover:bg-zinc-50 dark:hover:bg-zinc-800"
              >
                First Page
              </a>
            )}

            {result.pageInfo.hasNextPage && result.pageInfo.endCursor && (
              <a
                href={`/products?cursor=${encodeURIComponent(result.pageInfo.endCursor)}`}
                class="px-4 py-2 bg-emerald-900 text-white rounded hover:bg-emerald-800"
              >
                Next Page
              </a>
            )}
          </nav>
        )}
      </>
    ) : (
      <div class="text-center py-12">
        <p class="text-gray-500">No products found.</p>
      </div>
    )}
  </section>
</BaseLayout>
